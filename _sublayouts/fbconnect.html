<?php

require MODPATH.'facebook-php-sdk/src/facebook.php';
require MODPATH.'facebook-php-sdk/src/facebook.config.php';

// Create our Application instance (replace this with your appId and secret).
$facebook = new Facebook(array(
  'appId'  => FACEBOOK_APP_ID,
  'secret' => FACEBOOK_SECRET,
  'cookie' => true,
));

// We may or may not have this data based on a $_GET or $_COOKIE based session.
//
// If we get a session here, it means we found a correctly signed session using
// the Application Secret only Facebook and the Application know. We dont know
// if it is still valid until we make an API call using the session. A session
// can become invalid if it has already expired (should not be getting the
// session back in this case) or if the user logged out of Facebook.
$session = $facebook->getSession();

$me = null;
$uid = null;
$profile = null;
// Session based API call.
if ($session) {
  try {
    $uid = $facebook->getUser();
  } catch (FacebookApiException $e) {
    error_log($e);
  }
}

// login or logout url will be needed depending on current user state.
if ($uid) {
  $logoutUrl = $facebook->getLogoutUrl();

  $db = Database::instance();

  $result = $db->
    from('fbaccounts')->
    select(array('fbid', 'userid'))->
    where('fbid', $uid)->
    limit(1)->
    get();

  $userId = null;

  $profile = array();

  if (count($result)) {
    foreach ($result as $row) {
      $userrel = $row;
      break;
    }
    $userId = $userrel->userid;

    $result = $db->
      from('accounts')->
      select(array('name', 'first_name', 'last_name'))->
      where('id', $userId)->
      limit(1)->
      get();

    if (count($result)) {
      foreach ($result as $row) {
        $userInfo = $row;
        break;
      }
      
      $profile['name'] = $userInfo->name;
      $profile['first_name'] = $userInfo->first_name;
      $profile['last_name'] = $userInfo->last_name;
    }
    
  } else {  
    $me = $facebook->api('/me');
    
    $dataToStore = array(
      'name' => $me['name'],
      'first_name' => $me['first_name'],
      'last_name' => $me['last_name'],
    );
    $profile = $dataToStore;
    $userInfo = $db->insert('accounts', $dataToStore);
    $userId = $userInfo->insert_id();
    
    $dataToStore = array(
      'fbid' => $uid,
      'userid' => $userId,
    );
    $userInfo = $db->insert('fbaccounts', $dataToStore);
  }
  
  $profile['fbid'] = $uid;
  unset($uid);

} else {
  $loginUrl = $facebook->getLoginUrl();
}

// This call will always work since we are fetching public data.
//$naitik = $facebook->api('/naitik');

?>